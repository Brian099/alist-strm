{% extends 'index.html' %}

{% block content %}
<div class="container">
    <h1>STRM æ–‡ä»¶æµè§ˆå™¨</h1>
    
    <!-- é…ç½®é€‰æ‹©å™¨ -->
    <div class="mb-4">
        <label for="configSelect" class="form-label">é€‰æ‹©é…ç½®</label>
        <select class="form-select" id="configSelect">
            <option value="">è¯·é€‰æ‹©é…ç½®...</option>
            {% for config in configs %}
            <option value="{{ config[0] }}">{{ config[1] }} (ID: {{ config[0] }})</option>
            {% endfor %}
        </select>
    </div>

    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb" id="breadcrumb">
            <li class="breadcrumb-item active">è¯·é€‰æ‹©é…ç½®</li>
        </ol>
    </nav>

    <!-- æ–‡ä»¶åˆ—è¡¨ -->
    <div class="list-group" id="fileList">
        <!-- æ–‡ä»¶é¡¹å°†é€šè¿‡ JS åŠ¨æ€æ’å…¥ -->
        <div class="list-group-item text-muted">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé…ç½®ä»¥æµè§ˆæ–‡ä»¶ã€‚</div>
    </div>
</div>

<script>
    let currentConfigId = null;
    let currentPath = '';

    const configSelect = document.getElementById('configSelect');
    const fileList = document.getElementById('fileList');
    const breadcrumb = document.getElementById('breadcrumb');

    configSelect.addEventListener('change', function() {
        currentConfigId = this.value;
        currentPath = '';
        if (currentConfigId) {
            loadDirectory(currentConfigId, currentPath);
        } else {
            fileList.innerHTML = '<div class="list-group-item text-muted">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé…ç½®ä»¥æµè§ˆæ–‡ä»¶ã€‚</div>';
            updateBreadcrumb();
        }
    });

    function loadDirectory(configId, path) {
        // æ˜¾ç¤ºåŠ è½½ä¸­
        fileList.innerHTML = '<div class="list-group-item text-center"><div class="spinner-border text-primary" role="status"></div><span class="ms-2">åŠ è½½ä¸­...</span></div>';
        
        // æ›´æ–°é¢åŒ…å±‘
        updateBreadcrumb(path);

        fetch(`/api/browse_strm?config_id=${configId}&path=${encodeURIComponent(path)}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    fileList.innerHTML = `<div class="list-group-item list-group-item-danger">é”™è¯¯: ${data.error}</div>`;
                    return;
                }
                renderFileList(data.items);
            })
            .catch(error => {
                fileList.innerHTML = `<div class="list-group-item list-group-item-danger">è¯·æ±‚å¤±è´¥: ${error}</div>`;
            });
    }

    function renderFileList(items) {
        fileList.innerHTML = '';
        
        if (items.length === 0) {
            fileList.innerHTML = '<div class="list-group-item text-muted">ç©ºç›®å½•</div>';
            return;
        }

        // å¦‚æœä¸æ˜¯æ ¹ç›®å½•ï¼Œæ·»åŠ è¿”å›ä¸Šä¸€çº§
        if (currentPath) {
            const parentPath = currentPath.split('/').slice(0, -1).join('/');
            const backItem = document.createElement('a');
            backItem.href = '#';
            backItem.className = 'list-group-item list-group-item-action list-group-item-secondary';
            backItem.innerHTML = '<i class="bi bi-arrow-return-left"></i> .. (è¿”å›ä¸Šä¸€çº§)';
            backItem.onclick = (e) => {
                e.preventDefault();
                currentPath = parentPath;
                loadDirectory(currentConfigId, currentPath);
            };
            fileList.appendChild(backItem);
        }

        items.forEach(item => {
            const el = document.createElement('a');
            el.href = '#';
            el.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            
            if (item.type === 'directory') {
                el.innerHTML = `<span>ğŸ“ ${item.name}</span>`;
                el.onclick = (e) => {
                    e.preventDefault();
                    currentPath = currentPath ? `${currentPath}/${item.name}` : item.name;
                    loadDirectory(currentConfigId, currentPath);
                };
            } else {
                el.innerHTML = `<span>ğŸ“„ ${item.name}</span> <span class="badge bg-secondary rounded-pill">STRM</span>`;
                // æ–‡ä»¶ç‚¹å‡»æš‚æ—¶æ— åŠ¨ä½œï¼Œæˆ–è€…å¯ä»¥é¢„è§ˆå†…å®¹
            }
            fileList.appendChild(el);
        });
    }

    function updateBreadcrumb(path) {
        breadcrumb.innerHTML = '';
        
        // æ ¹ç›®å½•
        const rootItem = document.createElement('li');
        rootItem.className = 'breadcrumb-item';
        if (!path) {
            rootItem.className += ' active';
            rootItem.textContent = 'æ ¹ç›®å½•';
        } else {
            const link = document.createElement('a');
            link.href = '#';
            link.textContent = 'æ ¹ç›®å½•';
            link.onclick = (e) => {
                e.preventDefault();
                currentPath = '';
                loadDirectory(currentConfigId, currentPath);
            };
            rootItem.appendChild(link);
        }
        breadcrumb.appendChild(rootItem);

        if (path) {
            const parts = path.split('/');
            let accumPath = '';
            parts.forEach((part, index) => {
                accumPath = accumPath ? `${accumPath}/${part}` : part;
                const item = document.createElement('li');
                item.className = 'breadcrumb-item';
                
                if (index === parts.length - 1) {
                    item.className += ' active';
                    item.textContent = part;
                } else {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.textContent = part;
                    // ä½¿ç”¨é—­åŒ…ä¿å­˜å½“å‰çš„ accumPath
                    const targetPath = accumPath;
                    link.onclick = (e) => {
                        e.preventDefault();
                        currentPath = targetPath;
                        loadDirectory(currentConfigId, currentPath);
                    };
                    item.appendChild(link);
                }
                breadcrumb.appendChild(item);
            });
        }
    }
</script>
{% endblock %}
